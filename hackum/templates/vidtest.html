{% extends "base.html" %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript">
window.addEventListener("load", function() {

    var video = document.querySelector("#videl");
    var imgs = document.querySelector("#imgs");
    var canvas = document.createElement("canvas");
    var width, height;
    window.navigator = window.navigator || {};
    navigator.getUserMedia = (navigator.getUserMedia ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia ||
                              null);
    if(navigator.getUserMedia) {
        var createSrc = window.URL ? window.URL.createObjectURL : function(stream) {return stream;};
        navigator.getUserMedia({
            video: true,
            audio: true
        }, function(stream) {
            vidstream = stream;
            video.src = createSrc(vidstream);
            video.play();
        }, function(err) {
            console.error("getUserMedia", err);
        })
    }

    var desiredWidth = 640;

    video.addEventListener('canplay', function(ev) {
        width = desiredWidth;
        height = video.videoHeight / (video.videoWidth / desiredWidth);

        video.setAttribute('width', width);
        video.setAttribute('height', height);
        canvas.setAttribute('width', width);
        canvas.setAttribute('height', height);

    });

    takePic = function() {
        if(width && height) {
            var context = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            context.drawImage(video, 0, 0, width, height);
            var data = canvas.toDataURL('image/png');
            return data;
        }
    }

    showPic = function(data) {
        var e = document.createElement('img');
        e.src = data;
        imgs.appendChild(e);
    }

    showTxt = function(txt) {
        var p = document.createElement('p');
        p.innerHTML = txt;
        imgs.appendChild(p);
    }

    var apiEndpoint = "{% url 'api' %}";

    sendPic = function() {
        var pic = takePic();
        var fmt = pic.split("data:")[1];
        var fmt = fmt.split(";base64,");
        var b64 = fmt[1];
        fmt = fmt[0];
        var blob = b64toblob(b64, fmt);
        console.debug(blob);
        var formData = new FormData();
        formData.append('file', blob);
        console.info(formData);
        showPic(pic);
        filePOST(apiEndpoint, formData, function(data) {
            var jdata = JSON.parse(data);
            console.info(jdata);
            parseResp(jdata);
        });
    }

    parseResp = function(data) {
        if(!data || data["status_code"] != "OK") {
            return showTxt("Error");
        }
        var ares = data["results"];
        console.log(ares);
        for(var i=0; i<ares.length; i++) {
            var txt = "";
            var tags = ares[i]["result"]["tag"];
            for(var j=0; j<tags["classes"].length; j++) {
                var p = (tags["probs"][j] - 0.5) * 2;
                txt += "<span style='opacity: " + p + ";'>" + tags["classes"][j] + "</span> ";
            }
            showTxt(txt);
        }
    }

});
</script>
{% endblock %}

{% block content %}



<video id="videl" muted></video>
<br />
<br />
<button onclick="sendPic()">Take Photo</button>
<br />
<div id="imgs"></script>

{% endblock %}